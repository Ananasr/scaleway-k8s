---
# Setting up all hosts
- hosts: proxy:masters:workers
  become: true
  tasks: [ ]

# Proxy has public ip
#- hosts: proxy
#  roles:
#    - iptables

# this force reload iptables
#- hosts: proxy
#  tasks:
#    - meta: flush_handlers

- hosts: proxy
  become: true
  roles:
    - tinyproxy

# this force reload tinyproxy
- hosts: proxy
  become: true
  tasks:
    - meta: flush_handlers

# Setting up apt-proxy on master and workers (private ips)
- hosts: proxy:masters:workers
  become: true
  roles:
    - apt-proxy

# Setting mesh vpn using tinc
- hosts: proxy:masters:workers
  become: true
  roles:
    - tinc

# Proxy is now listening on tinc ip
- hosts: proxy
  become: true
  roles:
    - tinyproxy

- hosts: proxy
  become: true
  tasks:
    - meta: flush_handlers

# Apt proxy now should use tinc ip
- hosts: proxy:masters:workers
  become: true
  roles:
    - apt-proxy

# Ready to install docker
- hosts: proxy:masters:workers
  become: true
  roles:
    - common
    - docker

# Manual etc when we have more than 1 masters
- hosts: masters
  become: true
  roles:
    - etcd

- hosts: proxy:masters:workers
  become: true
  roles:
    - kubernetes

- hosts: proxy:masters:workers
  become: true
  roles:
    - kubernetes-multimasters

# Deploying ingress controller, lego, dashboard, and helm-monocular
- hosts: masters:proxy
  become: true
  roles:
    - ingress
    - lego
    - kubernetes-dashboard
    #- helm-monocular

- hosts: masters:proxy:workers
  become: true
  roles:
    - heketi-gluster
